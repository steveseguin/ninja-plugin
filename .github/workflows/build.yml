name: Build OBS VDO.Ninja Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PLUGIN_NAME: obs-vdoninja
  OBS_VERSION: 31.1.2
  OBS_SOURCE_REF: 31.1.2
  OBS_SOURCE_TAG: 31.1.2
  OBS_VERSION_WIN: "31.1.2"
  OBS_VERSION_WIN_ZIP: "OBS-Studio-31.1.2-Windows-x64.zip"

jobs:
  build-linux:
    name: Linux
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            libpthread-stubs0-dev \
            libcurl4-openssl-dev \
            libjsoncpp-dev

      - name: Build OBS SDK
        run: |
          git clone --depth 1 --branch ${{ env.OBS_SOURCE_REF }} --recurse-submodules https://github.com/obsproject/obs-studio.git obs-studio
          cd obs-studio
          git checkout "refs/tags/${{ env.OBS_SOURCE_TAG }}" || git checkout ${{ env.OBS_SOURCE_TAG }}
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ccache \
            extra-cmake-modules \
            lsb-release \
            dh-cmake \
            libglib2.0-dev \
            libavcodec-dev \
            libavdevice-dev \
            libavfilter-dev \
            libavformat-dev \
            libavutil-dev \
            libswresample-dev \
            libswscale-dev \
            libjansson-dev \
            libx11-xcb-dev \
            libgles2-mesa-dev \
            libwayland-dev \
            libpipewire-0.3-dev \
            libpulse-dev \
            libx264-dev \
            libmbedtls-dev \
            libgl1-mesa-dev \
            uthash-dev \
            libsimde-dev \
            libluajit-5.1-dev \
            python3-dev \
            libx11-dev \
            libxcb-randr0-dev \
            libxcb-shm0-dev \
            libxcb-xinerama0-dev \
            libxcb-composite0-dev \
            libxinerama-dev \
            libxcb1-dev \
            libxcb-xfixes0-dev \
            swig \
            libcmocka-dev \
            libxss-dev \
            libglvnd-dev \
            libxkbcommon-dev \
            libatk1.0-dev \
            libatk-bridge2.0-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libasound2-dev \
            libfdk-aac-dev \
            libfontconfig-dev \
            libfreetype6-dev \
            libjack-jackd2-dev \
            libsndio-dev \
            libspeexdsp-dev \
            libudev-dev \
            libv4l-dev \
            libva-dev \
            libvlc-dev \
            libpci-dev \
            libdrm-dev \
            nlohmann-json3-dev \
            libwebsocketpp-dev \
            libasio-dev \
            libqrcodegencpp-dev \
            libffmpeg-nvenc-dev \
            libsrt-openssl-dev \
            qt6-base-dev \
            libqt6svg6-dev \
            qt6-base-private-dev \
            libvpl-dev \
            libvpl2
          cmake -S . -B build_ubuntu \
            --preset ubuntu-ci \
            -DENABLE_BROWSER=OFF \
            -DENABLE_UI=OFF \
            -DENABLE_QT=OFF \
            -DENABLE_SCRIPTING=OFF \
            -DENABLE_RIST=OFF \
            -DOBS_VERSION_OVERRIDE=${{ env.OBS_VERSION }}
          cmake --build build_ubuntu --config RelWithDebInfo --parallel
          cmake --install build_ubuntu --prefix ${{ github.workspace }}/obs-sdk --component obs-libraries
          cmake --install build_ubuntu --prefix ${{ github.workspace }}/obs-sdk --component obs-headers
          cmake --install build_ubuntu --prefix ${{ github.workspace }}/obs-sdk --component obs-frontend-api

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DNO_EXAMPLES=ON \
            -DNO_TESTS=ON \
            -DUSE_GNUTLS=OFF \
            -DUSE_NICE=OFF \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build build
          sudo cmake --install build

      - name: Configure Plugin
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_PREFIX_PATH="/usr/local;${{ github.workspace }}/obs-sdk" \
            -DOBS_SDK_PATH="${{ github.workspace }}/obs-sdk"

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          cd install
          tar -czvf ../${{ env.PLUGIN_NAME }}-linux-x86_64.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-linux-x86_64
          path: ${{ env.PLUGIN_NAME }}-linux-x86_64.tar.gz

  build-macos:
    name: macOS
    runs-on: macos-14
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          brew install cmake ninja openssl@3 qt@5

      - name: Build OBS SDK
        run: |
          git clone --depth 1 --branch ${{ env.OBS_SOURCE_REF }} --recurse-submodules https://github.com/obsproject/obs-studio.git obs-studio
          cd obs-studio
          git checkout "refs/tags/${{ env.OBS_SOURCE_TAG }}" || git checkout ${{ env.OBS_SOURCE_TAG }}
          export DEVELOPER_DIR=$(ls -d /Applications/Xcode_*.app 2>/dev/null | sort -V | tail -1)/Contents/Developer
          cmake --preset macos-ci -B build_macos \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DENABLE_BROWSER=OFF \
            -DENABLE_UI=OFF \
            -DENABLE_QT=OFF \
            -DENABLE_SCRIPTING=OFF \
            -DOBS_VERSION_OVERRIDE=${{ env.OBS_VERSION }}
          cmake --build build_macos --config RelWithDebInfo
          cmake --install build_macos --prefix ${{ github.workspace }}/obs-sdk --component obs-libraries
          cmake --install build_macos --prefix ${{ github.workspace }}/obs-sdk --component obs-headers
          cmake --install build_macos --prefix ${{ github.workspace }}/obs-sdk --component obs-frontend-api

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/deps \
            -DNO_EXAMPLES=ON \
            -DNO_TESTS=ON \
            -DUSE_GNUTLS=OFF \
            -DUSE_NICE=OFF \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake --build build
          cmake --install build

      - name: Configure Plugin
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/deps;${{ github.workspace }}/obs-sdk;$(brew --prefix qt@5);$(brew --prefix openssl@3)" \
            -DOBS_SDK_PATH="${{ github.workspace }}/obs-sdk" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          cd install
          zip -r ../${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}
          path: ${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}.zip

  build-macos-universal:
    name: macOS Universal
    needs: build-macos
    runs-on: macos-14
    steps:
      - name: Download x86_64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-x86_64
          path: x86_64

      - name: Download arm64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-arm64
          path: arm64

      - name: Create Universal Binary
        run: |
          mkdir -p universal
          cd x86_64 && unzip *.zip -d ../x86_64_extracted && cd ..
          cd arm64 && unzip *.zip -d ../arm64_extracted && cd ..

          # Find and lipo all dylib files
          mkdir -p universal/lib/obs-plugins
          for f in $(find x86_64_extracted -name "*.dylib" -o -name "*.so"); do
            fname=$(basename "$f")
            arm_file=$(find arm64_extracted -name "$fname" | head -1)
            if [ -n "$arm_file" ]; then
              lipo -create "$f" "$arm_file" -output "universal/lib/obs-plugins/$fname"
            fi
          done

          # Copy data files from either arch (they should be identical)
          cp -R x86_64_extracted/share universal/ 2>/dev/null || true

          cd universal
          zip -r ../${{ env.PLUGIN_NAME }}-macos-universal.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-universal
          path: ${{ env.PLUGIN_NAME }}-macos-universal.zip

  build-windows:
    name: Windows
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Dependencies
        run: |
          choco install cmake ninja 7zip git -y
          vcpkg install openssl:x64-windows

      - name: Build OBS SDK
        run: |
          git clone --depth 1 --branch ${{ env.OBS_SOURCE_REF }} --recurse-submodules https://github.com/obsproject/obs-studio.git obs-studio
          cd obs-studio
          git checkout "refs/tags/${{ env.OBS_SOURCE_TAG }}"; if ($LASTEXITCODE -ne 0) { git checkout ${{ env.OBS_SOURCE_TAG }} }
          cmake --preset windows-ci-x64 -B build_x64 `
            "-DENABLE_BROWSER=OFF" `
            "-DENABLE_UI=OFF" `
            "-DENABLE_QT=OFF" `
            "-DENABLE_SCRIPTING=OFF" `
            "-DOBS_VERSION_OVERRIDE=${{ env.OBS_VERSION }}"
          cmake --build --preset windows-x64 --config RelWithDebInfo --parallel
          cmake --install build_x64 --prefix "${{ github.workspace }}\obs-sdk" --config RelWithDebInfo --component obs-libraries
          cmake --install build_x64 --prefix "${{ github.workspace }}\obs-sdk" --config RelWithDebInfo --component obs-headers
          cmake --install build_x64 --prefix "${{ github.workspace }}\obs-sdk" --config RelWithDebInfo --component obs-frontend-api
          Get-ChildItem -Path "${{ github.workspace }}\obs-sdk" -Recurse | Select-Object -First 200

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}\deps" `
            -DNO_EXAMPLES=ON `
            -DNO_TESTS=ON `
            -DUSE_GNUTLS=OFF `
            -DUSE_NICE=OFF `
            "-DCMAKE_POLICY_VERSION_MINIMUM=3.5.0" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
          cmake --build build
          cmake --install build

      - name: Configure Plugin
        run: |
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}\deps;${{ github.workspace }}\obs-sdk" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DOBS_SDK_PATH="${{ github.workspace }}\obs-sdk"

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          7z a ${{ env.PLUGIN_NAME }}-windows-x64.zip .\install\*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-windows-x64
          path: ${{ env.PLUGIN_NAME }}-windows-x64.zip

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos-universal, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.zip" -o -name "*.tar.gz" \) -exec mv {} . \;
          sha256sum *.zip *.tar.gz > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') || contains(github.ref, '-rc') }}
          generate_release_notes: true
          files: |
            artifacts/*.zip
            artifacts/*.tar.gz
            artifacts/checksums.txt
