name: Build OBS VDO.Ninja Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PLUGIN_NAME: obs-vdoninja
  OBS_VERSION: 30.0.0
  OBS_VERSION_WIN: "30.0"

jobs:
  build-linux:
    name: Linux
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            libpthread-stubs0-dev \
            qtbase5-dev \
            libqt5svg5-dev \
            libcurl4-openssl-dev \
            libjsoncpp-dev

      - name: Download OBS SDK
        run: |
          curl -L -o obs-studio.deb \
            "https://github.com/obsproject/obs-studio/releases/download/${{ env.OBS_VERSION }}/obs-studio_${{ env.OBS_VERSION }}-0obsproject1.jammy_amd64.deb"
          dpkg -x obs-studio.deb obs-sdk

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DNO_EXAMPLES=ON \
            -DNO_TESTS=ON \
            -DUSE_GNUTLS=OFF \
            -DUSE_NICE=OFF
          cmake --build build
          sudo cmake --install build

      - name: Configure Plugin
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_PREFIX_PATH="/usr/local;${{ github.workspace }}/obs-sdk/usr"

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          cd install
          tar -czvf ../${{ env.PLUGIN_NAME }}-linux-x86_64.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-linux-x86_64
          path: ${{ env.PLUGIN_NAME }}-linux-x86_64.tar.gz

  build-macos:
    name: macOS
    runs-on: macos-14
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          brew install cmake ninja openssl@3 qt@5

      - name: Install OBS
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            obs_dmg="OBS-Studio-${{ env.OBS_VERSION }}-macOS-Apple.dmg"
          else
            obs_dmg="OBS-Studio-${{ env.OBS_VERSION }}-macOS-Intel.dmg"
          fi
          curl -L -o obs-studio.dmg \
            "https://github.com/obsproject/obs-studio/releases/download/${{ env.OBS_VERSION }}/${obs_dmg}"
          hdiutil attach obs-studio.dmg
          obs_volume=$(ls /Volumes | grep -m 1 "OBS" || true)
          obs_app=$(find "/Volumes/${obs_volume}" -maxdepth 1 -name "*.app" | head -1)
          if [ -z "${obs_app}" ]; then
            echo "OBS app not found in mounted DMG"
            exit 1
          fi
          sudo cp -R "${obs_app}" /Applications/OBS.app
          hdiutil detach "/Volumes/${obs_volume}"

      - name: Prepare OBS SDK
        run: |
          OBS_APP="/Applications/OBS.app"
          if [ ! -d "${OBS_APP}" ]; then
            OBS_APP="/Applications/OBS Studio.app"
          fi
          if [ ! -d "${OBS_APP}" ]; then
            echo "OBS.app not found in /Applications"
            exit 1
          fi
          OBS_FRAMEWORK="${OBS_APP}/Contents/Frameworks/obs.framework"
          FRONTEND_FRAMEWORK="${OBS_APP}/Contents/Frameworks/obs-frontend-api.framework"
          OBS_HEADERS=$(find "${OBS_FRAMEWORK}" -path "*/Headers" -type d | head -1)
          FRONTEND_HEADERS=$(find "${FRONTEND_FRAMEWORK}" -path "*/Headers" -type d | head -1)
          OBS_LIB=$(find "${OBS_FRAMEWORK}" -type f -name "obs" | head -1)
          FRONTEND_LIB=$(find "${FRONTEND_FRAMEWORK}" -type f -name "obs-frontend-api" | head -1)
          if [ -z "${OBS_HEADERS}" ] || [ -z "${FRONTEND_HEADERS}" ] || [ -z "${OBS_LIB}" ] || [ -z "${FRONTEND_LIB}" ]; then
            echo "OBS SDK headers or libraries not found"
            exit 1
          fi
          mkdir -p obs-sdk/include obs-sdk/lib
          cp -R "${OBS_HEADERS}" obs-sdk/include/obs
          cp -R "${FRONTEND_HEADERS}" obs-sdk/include/obs-frontend-api
          cp -R "${OBS_LIB}" obs-sdk/lib/libobs.dylib
          cp -R "${FRONTEND_LIB}" obs-sdk/lib/libobs-frontend-api.dylib

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/deps \
            -DNO_EXAMPLES=ON \
            -DNO_TESTS=ON \
            -DUSE_GNUTLS=OFF \
            -DUSE_NICE=OFF \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake --build build
          cmake --install build

      - name: Configure Plugin
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/deps;${{ github.workspace }}/obs-sdk;$(brew --prefix qt@5);$(brew --prefix openssl@3)" \
            -DOBS_INCLUDE_DIRS="${{ github.workspace }}/obs-sdk/include/obs" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          cd install
          zip -r ../${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}
          path: ${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}.zip

  build-macos-universal:
    name: macOS Universal
    needs: build-macos
    runs-on: macos-14
    steps:
      - name: Download x86_64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-x86_64
          path: x86_64

      - name: Download arm64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-arm64
          path: arm64

      - name: Create Universal Binary
        run: |
          mkdir -p universal
          cd x86_64 && unzip *.zip -d ../x86_64_extracted && cd ..
          cd arm64 && unzip *.zip -d ../arm64_extracted && cd ..

          # Find and lipo all dylib files
          mkdir -p universal/lib/obs-plugins
          for f in $(find x86_64_extracted -name "*.dylib" -o -name "*.so"); do
            fname=$(basename "$f")
            arm_file=$(find arm64_extracted -name "$fname" | head -1)
            if [ -n "$arm_file" ]; then
              lipo -create "$f" "$arm_file" -output "universal/lib/obs-plugins/$fname"
            fi
          done

          # Copy data files from either arch (they should be identical)
          cp -R x86_64_extracted/share universal/ 2>/dev/null || true

          cd universal
          zip -r ../${{ env.PLUGIN_NAME }}-macos-universal.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-universal
          path: ${{ env.PLUGIN_NAME }}-macos-universal.zip

  build-windows:
    name: Windows
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Dependencies
        run: |
          choco install cmake ninja 7zip -y
          vcpkg install openssl:x64-windows

      - name: Download OBS SDK
        run: |
          $obsVersionWin = "${{ env.OBS_VERSION_WIN }}"
          if (-not $obsVersionWin.EndsWith(".zip")) {
            $obsZip = "OBS-Studio-$obsVersionWin.zip"
          } else {
            $obsZip = $obsVersionWin
          }
          Invoke-WebRequest -Uri "https://github.com/obsproject/obs-studio/releases/download/${{ env.OBS_VERSION }}/$obsZip" -OutFile "obs-sdk.zip"
          Expand-Archive -Path "obs-sdk.zip" -DestinationPath "obs-sdk"
          if (Test-Path "obs-sdk\obs-studio\sdk") {
            Copy-Item "obs-sdk\obs-studio\sdk\*" -Destination "obs-sdk" -Recurse -Force
          } else {
            Copy-Item "obs-sdk\sdk\*" -Destination "obs-sdk" -Recurse -Force
          }

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}\deps" `
            -DNO_EXAMPLES=ON `
            -DNO_TESTS=ON `
            -DUSE_GNUTLS=OFF `
            -DUSE_NICE=OFF `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
          cmake --build build
          cmake --install build

      - name: Configure Plugin
        run: |
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}\deps;${{ github.workspace }}\obs-sdk" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DOBS_INCLUDE_DIRS="${{ github.workspace }}\obs-sdk\include"

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          7z a ${{ env.PLUGIN_NAME }}-windows-x64.zip .\install\*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-windows-x64
          path: ${{ env.PLUGIN_NAME }}-windows-x64.zip

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos-universal, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.zip" -o -name "*.tar.gz" \) -exec mv {} . \;
          sha256sum *.zip *.tar.gz > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') || contains(github.ref, '-rc') }}
          generate_release_notes: true
          files: |
            artifacts/*.zip
            artifacts/*.tar.gz
            artifacts/checksums.txt
