name: Build OBS VDO.Ninja Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PLUGIN_NAME: obs-vdoninja
  OBS_VERSION: 31.1.2
  OBS_SOURCE_REF: 31.1.2
  OBS_SOURCE_TAG: 31.1.2
  OBS_VERSION_WIN: "31.1.2"
  OBS_VERSION_WIN_ZIP: "OBS-Studio-31.1.2-Windows-x64.zip"

jobs:
  build-linux:
    name: Linux
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libssl-dev \
            libpthread-stubs0-dev \
            libcurl4-openssl-dev \
            libjsoncpp-dev

      - name: Build OBS SDK
        run: |
          git clone --depth 1 --branch ${{ env.OBS_SOURCE_REF }} --recurse-submodules https://github.com/obsproject/obs-studio.git obs-studio
          cd obs-studio
          git checkout "refs/tags/${{ env.OBS_SOURCE_TAG }}" || git checkout ${{ env.OBS_SOURCE_TAG }}
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ccache \
            extra-cmake-modules \
            lsb-release \
            dh-cmake \
            libglib2.0-dev \
            libavcodec-dev \
            libavdevice-dev \
            libavfilter-dev \
            libavformat-dev \
            libavutil-dev \
            libswresample-dev \
            libswscale-dev \
            libjansson-dev \
            libx11-xcb-dev \
            libgles2-mesa-dev \
            libwayland-dev \
            libpipewire-0.3-dev \
            libpulse-dev \
            libx264-dev \
            libmbedtls-dev \
            libgl1-mesa-dev \
            uthash-dev \
            libsimde-dev \
            libluajit-5.1-dev \
            python3-dev \
            libx11-dev \
            libxcb-randr0-dev \
            libxcb-shm0-dev \
            libxcb-xinerama0-dev \
            libxcb-composite0-dev \
            libxinerama-dev \
            libxcb1-dev \
            libxcb-xfixes0-dev \
            swig \
            libcmocka-dev \
            libxss-dev \
            libglvnd-dev \
            libxkbcommon-dev \
            libatk1.0-dev \
            libatk-bridge2.0-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libasound2-dev \
            libfdk-aac-dev \
            libfontconfig-dev \
            libfreetype6-dev \
            libjack-jackd2-dev \
            libsndio-dev \
            libspeexdsp-dev \
            libudev-dev \
            libv4l-dev \
            libva-dev \
            libvlc-dev \
            libpci-dev \
            libdrm-dev \
            nlohmann-json3-dev \
            libwebsocketpp-dev \
            libasio-dev \
            libqrcodegencpp-dev \
            libffmpeg-nvenc-dev \
            libsrt-openssl-dev \
            qt6-base-dev \
            libqt6svg6-dev \
            qt6-base-private-dev \
            libvpl-dev \
            libvpl2
          cmake -S . -B build_ubuntu \
            --preset ubuntu-ci \
            -DENABLE_BROWSER=OFF \
            -DENABLE_SCRIPTING=OFF \
            -DENABLE_RIST=OFF \
            -DENABLE_NEW_MPEGTS_OUTPUT=OFF \
            -DOBS_VERSION_OVERRIDE=${{ env.OBS_VERSION }}
          cmake --build build_ubuntu --config RelWithDebInfo --parallel
          cmake --install build_ubuntu --prefix ${{ github.workspace }}/obs-sdk
          echo "=== OBS SDK install tree ==="
          find ${{ github.workspace }}/obs-sdk -type f | head -100
          # Create symlinks from multiarch path to standard path
          mkdir -p ${{ github.workspace }}/obs-sdk/lib
          for f in ${{ github.workspace }}/obs-sdk/lib/x86_64-linux-gnu/*; do
            [ -e "$f" ] && ln -sf "$f" ${{ github.workspace }}/obs-sdk/lib/$(basename "$f") 2>/dev/null || true
          done
          # Create versioned symlinks
          ln -sf libobs.so.30 ${{ github.workspace }}/obs-sdk/lib/libobs.so
          ln -sf libobs-frontend-api.so.1 ${{ github.workspace }}/obs-sdk/lib/libobs-frontend-api.so 2>/dev/null || true
          # Fix pkgconfig files to use correct libdir
          if [ -d "${{ github.workspace }}/obs-sdk/lib/pkgconfig" ]; then
            sed -i "s|libdir=.*|libdir=${{ github.workspace }}/obs-sdk/lib|g" ${{ github.workspace }}/obs-sdk/lib/pkgconfig/*.pc 2>/dev/null || true
            cat ${{ github.workspace }}/obs-sdk/lib/pkgconfig/libobs.pc 2>/dev/null || echo "No libobs.pc"
          fi
          echo "=== After symlinks ==="
          ls -la ${{ github.workspace }}/obs-sdk/lib/

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DNO_EXAMPLES=ON \
            -DNO_TESTS=ON \
            -DUSE_GNUTLS=OFF \
            -DUSE_NICE=OFF \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build build
          sudo cmake --install build

      - name: Configure Plugin
        run: |
          echo "=== Checking OBS libraries ==="
          ls -la ${{ github.workspace }}/obs-sdk/lib/ || echo "No lib dir"
          find ${{ github.workspace }}/obs-sdk -name "*.so*" -o -name "*.a" | head -20
          # Don't set PKG_CONFIG_PATH to avoid pkg-config finding OBS with wrong paths
          # Force CMake to use find_library which will get full paths
          export OBS_LIB_DIR="${{ github.workspace }}/obs-sdk/lib"
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_PREFIX_PATH="/usr/local;${{ github.workspace }}/obs-sdk;${OBS_LIB_DIR}/cmake/libobs;${OBS_LIB_DIR}/cmake/obs-frontend-api" \
            -DCMAKE_LIBRARY_PATH="${OBS_LIB_DIR}" \
            -DOBS_SDK_PATH="${{ github.workspace }}/obs-sdk" \
            -DCMAKE_EXE_LINKER_FLAGS="-L${OBS_LIB_DIR} -Wl,-rpath,${OBS_LIB_DIR}" \
            -DCMAKE_SHARED_LINKER_FLAGS="-L${OBS_LIB_DIR} -Wl,-rpath,${OBS_LIB_DIR}"

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          cp LICENSE install/
          cp INSTALL.md install/
          cp THIRD_PARTY_LICENSES.md install/
          cp RELEASE_COMPLIANCE.md install/
          cp scripts/install-package-linux.sh install/install.sh
          cp scripts/uninstall-package-linux.sh install/uninstall.sh
          chmod +x install/install.sh
          chmod +x install/uninstall.sh
          cd install
          tar -czvf ../${{ env.PLUGIN_NAME }}-linux-x86_64.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-linux-x86_64
          path: ${{ env.PLUGIN_NAME }}-linux-x86_64.tar.gz

  build-macos:
    name: macOS
    runs-on: macos-14
    strategy:
      matrix:
        arch: [arm64]
        # x86_64 disabled: AGL framework removed in macOS 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          brew install cmake ninja openssl@3 qt@6 qt@5

      - name: Build OBS SDK
        run: |
          git clone --depth 1 --branch ${{ env.OBS_SOURCE_REF }} --recurse-submodules https://github.com/obsproject/obs-studio.git obs-studio
          cd obs-studio
          git checkout "refs/tags/${{ env.OBS_SOURCE_TAG }}" || git checkout ${{ env.OBS_SOURCE_TAG }}
          export DEVELOPER_DIR=$(ls -d /Applications/Xcode_*.app 2>/dev/null | sort -V | tail -1)/Contents/Developer
          cmake --preset macos-ci -B build_macos \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@6)" \
            -DENABLE_BROWSER=OFF \
            -DENABLE_SCRIPTING=OFF \
            -DOBS_VERSION_OVERRIDE=${{ env.OBS_VERSION }}
          cmake --build build_macos --config RelWithDebInfo
          cmake --install build_macos --prefix ${{ github.workspace }}/obs-sdk --config RelWithDebInfo
          echo "=== OBS SDK install tree ==="
          find ${{ github.workspace }}/obs-sdk -type f | head -100
          # Create versioned symlinks for macOS
          if [ -f "${{ github.workspace }}/obs-sdk/lib/libobs.0.dylib" ]; then
            ln -sf libobs.0.dylib ${{ github.workspace }}/obs-sdk/lib/libobs.dylib
          fi
          if [ -f "${{ github.workspace }}/obs-sdk/lib/libobs-frontend-api.1.dylib" ]; then
            ln -sf libobs-frontend-api.1.dylib ${{ github.workspace }}/obs-sdk/lib/libobs-frontend-api.dylib
          fi
          # Copy headers that aren't installed by default
          # OBS headers expect: include/obs.h, include/util/c99defs.h (not include/obs/...)
          mkdir -p ${{ github.workspace }}/obs-sdk/include
          mkdir -p ${{ github.workspace }}/obs-sdk/include/util
          mkdir -p ${{ github.workspace }}/obs-sdk/include/graphics
          mkdir -p ${{ github.workspace }}/obs-sdk/include/media-io
          mkdir -p ${{ github.workspace }}/obs-sdk/include/callback
          mkdir -p ${{ github.workspace }}/obs-sdk/include/obs-frontend-api
          cp libobs/*.h ${{ github.workspace }}/obs-sdk/include/ 2>/dev/null || true
          cp -r libobs/util/* ${{ github.workspace }}/obs-sdk/include/util/ 2>/dev/null || true
          cp -r libobs/graphics/* ${{ github.workspace }}/obs-sdk/include/graphics/ 2>/dev/null || true
          cp -r libobs/media-io/* ${{ github.workspace }}/obs-sdk/include/media-io/ 2>/dev/null || true
          cp -r libobs/callback/* ${{ github.workspace }}/obs-sdk/include/callback/ 2>/dev/null || true
          # Copy obs-frontend-api header (OBS 31+: now in frontend/api/)
          cp frontend/api/obs-frontend-api.h ${{ github.workspace }}/obs-sdk/include/obs-frontend-api/ 2>/dev/null || \
            cp UI/obs-frontend-api/obs-frontend-api.h ${{ github.workspace }}/obs-sdk/include/obs-frontend-api/ 2>/dev/null || true
          # Copy generated obsconfig.h from build directory (required by obs-config.h)
          cp build_macos/config/obsconfig.h ${{ github.workspace }}/obs-sdk/include/ 2>/dev/null || \
            cp build_macos/obsconfig.h ${{ github.workspace }}/obs-sdk/include/ 2>/dev/null || true
          # Verify libs and headers exist
          echo "=== Checking OBS libraries ==="
          ls -la ${{ github.workspace }}/obs-sdk/lib/ 2>/dev/null | head -20 || echo "No lib dir"
          ls -la ${{ github.workspace }}/obs-sdk/lib/cmake/ 2>/dev/null | head -20 || echo "No cmake dir"
          echo "=== Checking Frameworks ==="
          ls -la ${{ github.workspace }}/obs-sdk/OBS.app/Contents/Frameworks/ 2>/dev/null | head -30 || echo "No Frameworks dir"
          echo "=== Checking headers ==="
          ls -la ${{ github.workspace }}/obs-sdk/include/ 2>/dev/null | head -20 || echo "No include dir"
          ls -la ${{ github.workspace }}/obs-sdk/include/util/ 2>/dev/null | head -10 || echo "No util include dir"
          ls -la ${{ github.workspace }}/obs-sdk/include/obs-frontend-api/ 2>/dev/null || echo "No frontend-api include dir"

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/deps \
            -DNO_EXAMPLES=ON \
            -DNO_TESTS=ON \
            -DUSE_GNUTLS=OFF \
            -DUSE_NICE=OFF \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake --build build
          cmake --install build

      - name: Configure Plugin
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/deps;${{ github.workspace }}/obs-sdk;$(brew --prefix qt@5);$(brew --prefix openssl@3)" \
            -DOBS_SDK_PATH="${{ github.workspace }}/obs-sdk" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          cp LICENSE install/
          cp INSTALL.md install/
          cp THIRD_PARTY_LICENSES.md install/
          cp RELEASE_COMPLIANCE.md install/
          cp scripts/install-package-macos.sh install/install.sh
          cp scripts/uninstall-package-macos.sh install/uninstall.sh
          chmod +x install/install.sh
          chmod +x install/uninstall.sh
          cd install
          zip -r ../${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}
          path: ${{ env.PLUGIN_NAME }}-macos-${{ matrix.arch }}.zip

  # build-macos-universal disabled: x86_64 build not available due to AGL framework removal
  # build-macos-universal:
  #   name: macOS Universal
  #   needs: build-macos
  #   ...

  build-windows:
    name: Windows
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Dependencies
        run: |
          choco install cmake ninja 7zip git -y
          vcpkg install openssl:x64-windows pthreads:x64-windows

      - name: Build OBS SDK
        run: |
          git clone --depth 1 --branch ${{ env.OBS_SOURCE_REF }} --recurse-submodules https://github.com/obsproject/obs-studio.git obs-studio
          cd obs-studio
          git checkout "refs/tags/${{ env.OBS_SOURCE_TAG }}"; if ($LASTEXITCODE -ne 0) { git checkout ${{ env.OBS_SOURCE_TAG }} }
          cmake --preset windows-ci-x64 -B build_x64 `
            "-DENABLE_BROWSER=OFF" `
            "-DENABLE_SCRIPTING=OFF" `
            "-DOBS_VERSION_OVERRIDE=${{ env.OBS_VERSION }}"
          cmake --build --preset windows-x64 --config RelWithDebInfo --parallel
          cmake --install build_x64 --prefix "${{ github.workspace }}\obs-sdk" --config RelWithDebInfo
          # Copy headers that aren't installed by default
          # OBS headers expect: include/obs.h, include/util/c99defs.h (not include/obs/...)
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\obs-sdk\include"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\obs-sdk\include\util"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\obs-sdk\include\graphics"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\obs-sdk\include\media-io"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\obs-sdk\include\callback"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\obs-sdk\include\obs-frontend-api"
          # Copy only if cmake install didn't provide headers
          if (-not (Test-Path "${{ github.workspace }}\obs-sdk\include\obs.h")) {
            Copy-Item -Path "libobs\*.h" -Destination "${{ github.workspace }}\obs-sdk\include"
          }
          # Copy util headers but use -ErrorAction SilentlyContinue to not overwrite
          Copy-Item -Path "libobs\util\*" -Destination "${{ github.workspace }}\obs-sdk\include\util" -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path "libobs\graphics\*" -Destination "${{ github.workspace }}\obs-sdk\include\graphics" -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path "libobs\media-io\*" -Destination "${{ github.workspace }}\obs-sdk\include\media-io" -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path "libobs\callback\*" -Destination "${{ github.workspace }}\obs-sdk\include\callback" -Recurse -ErrorAction SilentlyContinue
          # Copy obs-frontend-api header (OBS 31+: now in frontend\api\)
          if (Test-Path "frontend\api\obs-frontend-api.h") {
            Copy-Item -Path "frontend\api\obs-frontend-api.h" -Destination "${{ github.workspace }}\obs-sdk\include\obs-frontend-api"
          } elseif (Test-Path "UI\obs-frontend-api\obs-frontend-api.h") {
            Copy-Item -Path "UI\obs-frontend-api\obs-frontend-api.h" -Destination "${{ github.workspace }}\obs-sdk\include\obs-frontend-api"
          }
          # Copy generated obsconfig.h from build directory (required by obs-config.h)
          if (Test-Path "build_x64\config\obsconfig.h") {
            Copy-Item -Path "build_x64\config\obsconfig.h" -Destination "${{ github.workspace }}\obs-sdk\include"
          } elseif (Test-Path "build_x64\obsconfig.h") {
            Copy-Item -Path "build_x64\obsconfig.h" -Destination "${{ github.workspace }}\obs-sdk\include"
          }
          # Verify threading-windows.h exists (required for Windows builds)
          Write-Host "=== Checking threading headers ==="
          Get-ChildItem "${{ github.workspace }}\obs-sdk\include\util\threading*" -ErrorAction SilentlyContinue
          # Copy import libraries
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\obs-sdk\lib"
          Copy-Item -Path "build_x64\libobs\RelWithDebInfo\obs.lib" -Destination "${{ github.workspace }}\obs-sdk\lib"
          # OBS 31+: obs-frontend-api.lib moved to frontend\api\
          if (Test-Path "build_x64\frontend\api\RelWithDebInfo\obs-frontend-api.lib") {
            Copy-Item -Path "build_x64\frontend\api\RelWithDebInfo\obs-frontend-api.lib" -Destination "${{ github.workspace }}\obs-sdk\lib"
          } elseif (Test-Path "build_x64\UI\obs-frontend-api\RelWithDebInfo\obs-frontend-api.lib") {
            Copy-Item -Path "build_x64\UI\obs-frontend-api\RelWithDebInfo\obs-frontend-api.lib" -Destination "${{ github.workspace }}\obs-sdk\lib"
          }
          Write-Host "=== OBS SDK install tree ==="
          Get-ChildItem -Path "${{ github.workspace }}\obs-sdk" -Recurse | Select-Object -First 100

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}\deps" `
            -DNO_EXAMPLES=ON `
            -DNO_TESTS=ON `
            -DUSE_GNUTLS=OFF `
            -DUSE_NICE=OFF `
            "-DCMAKE_POLICY_VERSION_MINIMUM=3.5.0" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
          cmake --build build
          cmake --install build

      - name: Configure Plugin
        run: |
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}\deps;${{ github.workspace }}\obs-sdk" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DOBS_SDK_PATH="${{ github.workspace }}\obs-sdk"

      - name: Build Plugin
        run: cmake --build build

      - name: Package
        run: |
          cmake --install build --prefix install
          Copy-Item LICENSE install\
          Copy-Item INSTALL.md install\
          Copy-Item THIRD_PARTY_LICENSES.md install\
          Copy-Item RELEASE_COMPLIANCE.md install\
          Copy-Item scripts\install-package-windows.ps1 install\install.ps1
          Copy-Item scripts\uninstall-package-windows.ps1 install\uninstall.ps1
          7z a ${{ env.PLUGIN_NAME }}-windows-x64.zip .\install\*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-windows-x64
          path: ${{ env.PLUGIN_NAME }}-windows-x64.zip

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.zip" -o -name "*.tar.gz" \) -exec mv {} . \;
          sha256sum *.zip *.tar.gz > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') || contains(github.ref, '-rc') }}
          generate_release_notes: true
          files: |
            artifacts/*.zip
            artifacts/*.tar.gz
            artifacts/checksums.txt
