name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # Run tests first
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libssl-dev

      - name: Configure and build tests
        run: |
          cmake -B build -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug
          cmake --build build --target vdoninja-tests -j$(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure

  # Build for all platforms
  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libssl-dev libobs-dev obs-studio

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DNO_EXAMPLES=ON -DNO_TESTS=ON -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build build -j$(nproc)
          sudo cmake --install build

      - name: Build plugin
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j$(nproc)

      - name: Package
        run: |
          cd build
          cpack -G DEB
          cpack -G TGZ

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            build/*.deb
            build/*.tar.gz

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Install vcpkg packages
        run: vcpkg install openssl:x64-windows

      - name: Download OBS deps
        run: |
          curl -L -o obs-deps.zip "https://github.com/obsproject/obs-deps/releases/download/2024-03-19/windows-deps-x64-2024-03-19.zip"
          7z x obs-deps.zip -o"obs-deps"

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DNO_EXAMPLES=ON -DNO_TESTS=ON -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake --build build --config Release
          cmake --install build --prefix "$PWD/../libdatachannel-install"

      - name: Build plugin
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" -DCMAKE_PREFIX_PATH="$PWD/libdatachannel-install;$PWD/obs-deps"
          cmake --build build --config Release

      - name: Package
        run: |
          cd build
          cpack -G ZIP -C Release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: build/*.zip

  build-macos:
    name: Build (macOS)
    runs-on: macos-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install cmake openssl@3

      - name: Build libdatachannel
        run: |
          git clone --depth 1 --branch v0.20.2 https://github.com/paullouisageneau/libdatachannel.git
          cd libdatachannel
          git submodule update --init --recursive --depth 1
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DNO_EXAMPLES=ON -DNO_TESTS=ON -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake --build build -j$(sysctl -n hw.ncpu)
          cmake --install build --prefix "$PWD/../libdatachannel-install"

      - name: Build plugin
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$PWD/libdatachannel-install" -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
          cmake --build build -j$(sysctl -n hw.ncpu)

      - name: Package
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: build/*.zip

  # Create GitHub Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: ls -la artifacts/*

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## OBS VDO.Ninja Plugin ${{ github.ref_name }}

            ### Installation

            **Linux (Debian/Ubuntu):**
            ```bash
            sudo dpkg -i obs-vdoninja-*.deb
            ```

            **Windows:**
            1. Extract the ZIP file
            2. Copy the plugin files to your OBS plugins directory:
               - `C:\Program Files\obs-studio\obs-plugins\64bit\`

            **macOS:**
            1. Extract the ZIP file
            2. Copy the plugin to:
               - `~/Library/Application Support/obs-studio/plugins/`

            ### Requirements
            - OBS Studio 30.0 or later
            - libdatachannel (bundled)

            ### Changelog
            See CHANGELOG.md for details.
          files: |
            artifacts/linux-release/*
            artifacts/windows-release/*
            artifacts/macos-release/*
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
